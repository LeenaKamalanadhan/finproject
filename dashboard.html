<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Dashboard - Secure Medical Portal</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- DataTables -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <style>
    :root {
      --primary: #0d6efd;
      --muted: #6c757d;
      --card-radius: 12px;
    }
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:#f6f8fb; }
    /* Sidebar */
    #sidebar {
      min-width: 220px;
      max-width: 220px;
      background: linear-gradient(180deg,#0d6efd,#0056b3);
      color: white;
      height: 100vh;
      position: fixed;
      padding-top: 20px;
    }
    #sidebar .nav-link { color: rgba(255,255,255,0.9); }
    #sidebar .nav-link.active { background: rgba(255,255,255,0.06); border-radius:8px; }
    /* Content */
    #main {
      margin-left: 240px;
      padding: 28px;
    }
    .card-stat { border-radius: 12px; }
    .card-body .stat-number { font-size: 1.6rem; font-weight: 700; }
    .chart-card { height: 320px; }
    .profile-icon { width:36px; height:36px; border-radius:50%; object-fit:cover; }
    .small-muted { color:var(--muted); font-size:0.9rem; }
    .toast-custom { position: fixed; right: 20px; bottom: 20px; z-index: 2000; }
    /* responsive */
    @media (max-width: 991px) {
      #sidebar { position: relative; width:100%; height:auto; }
      #main { margin-left:0; padding:16px; }
    }
  </style>
</head>
<body>

  <!-- SIDEBAR -->
  <aside id="sidebar" class="d-flex flex-column px-3">
    <div class="text-center mb-3">
      <img src="https://img.icons8.com/ios-filled/80/ffffff/hospital-room.png" width="64" alt="logo">
      <h5 class="mt-2 mb-0">Secure Medical Portal</h5>
      
    </div>

    <nav class="nav flex-column mb-3">
      <a class="nav-link active" href="dashboard.html"><i class="fa fa-home me-2"></i> Dashboard</a>
      <a class="nav-link" href="upload.html"><i class="fa fa-paper-plane me-2"></i> Upload reports</a>
      <a class="nav-link" href="fetch.html"><i class="fa fa-inbox me-2"></i> Fetch Reports</a>
    
      <a class="nav-link" href="history.html"><i class="fa fa-clock-rotate-left me-2"></i> History</a>
      <a class="nav-link" href="users.html"><i class="fa fa-users me-2"></i> Staff</a>
      <a class="nav-link" href="settings.html"><i class="fa fa-gear me-2"></i> Settings</a>
    </nav>

    <div class="mt-auto small text-white-50 px-2 pb-3">
      <div>Version 1.0</div>
      <div class="small-muted">© 2025 Secure Medical</div>
    </div>
  </aside>

  <!-- MAIN -->
  <div id="main">
    <!-- TOP NAV -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h4 id="welcomeMessage" class="mb-0">Welcome, <span id="userShortName">Dr.Chithra</span></h4>
        <small class="small-muted" id="todayDate"></small>
      </div>

      <div class="d-flex align-items-center gap-3">
        <!-- Quick search -->
        <div class="input-group d-none d-md-flex" style="min-width:280px;">
          <span class="input-group-text bg-white"><i class="fa fa-search"></i></span>
          <input id="globalSearch" class="form-control" placeholder="Search patients, id or reports...">
        </div>

        <!-- Notifications -->
        <div class="dropdown">
          <button class="btn btn-outline-secondary position-relative" id="notifBtn" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="fa fa-bell"></i>
            <span id="notifCount" class="badge bg-danger position-absolute top-0 start-100 translate-middle rounded-pill">0</span>
          </button>
          <ul class="dropdown-menu dropdown-menu-end" style="min-width:320px;" id="notifList">
            <li class="dropdown-header">Notifications</li>
            <li><hr class="dropdown-divider"></li>
            <!-- notifications injected here -->
            <li class="text-center small text-muted">No notifications</li>
          </ul>
        </div>

        <!-- Profile -->
        <div class="dropdown">
          <a class="d-flex align-items-center text-decoration-none dropdown-toggle" id="profileMenu" data-bs-toggle="dropdown" href="#">
            <img id="profileThumb" class="profile-icon me-2" src="https://img.icons8.com/ios-filled/100/000000/user.png" alt="profile">
            <div class="text-end d-none d-md-block">
              <div id="profileNameTop">Dr. User</div>
              <small class="small-muted" id="profileRoleTop">Doctor</small>
            </div>
          </a>
          <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="profileMenu">
            <li class="dropdown-item-text"><strong id="profileName">Dr. User</strong><br><small id="profileEmail">email@hospital.com</small></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="profile.html"><i class="fa fa-user me-2"></i> Profile</a></li>
            <li><a class="dropdown-item" href="settings.html"><i class="fa fa-gear me-2"></i> Settings</a></li>
            <li><a class="dropdown-item" href="#" id="logoutBtn"><i class="fa fa-sign-out-alt me-2"></i> Logout</a></li>
          </ul>
        </div>
      </div>
    </div>

    <!-- STATS CARDS -->
    <div class="row g-3 mb-4">
      <div class="col-md-3">
        <div class="card card-stat shadow-sm">
          <div class="card-body">
            <div class="small-muted">Patients Today</div>
            <div class="stat-number" id="statPatients">—</div>
            <div class="small-muted">Active: <span id="statActive">—</span></div>
          </div>
        </div>
      </div>

      <div class="col-md-3">
        <div class="card card-stat shadow-sm">
          <div class="card-body">
            <div class="small-muted">Appointments</div>
            <div class="stat-number" id="statAppointments">—</div>
            <div class="small-muted">Upcoming: <span id="statUpcoming">—</span></div>
          </div>
        </div>
      </div>

      <div class="col-md-3">
        <div class="card card-stat shadow-sm">
          <div class="card-body">
            <div class="small-muted">Pending Reports</div>
            <div class="stat-number text-warning" id="statReports">—</div>
            <div class="small-muted">Unreviewed: <span id="statUnreviewed">—</span></div>
          </div>
        </div>
      </div>

      <div class="col-md-3">
        <div class="card card-stat shadow-sm">
          <div class="card-body">
            <div class="small-muted">Alerts</div>
            <div class="stat-number text-danger" id="statAlerts">—</div>
            <div class="small-muted">Critical: <span id="statCritical">—</span></div>
          </div>
        </div>
      </div>
    </div>

    <!-- CHARTS -->
    <div class="row g-3 mb-4">
      <div class="col-lg-8">
        <div class="card chart-card shadow-sm">
          <div class="card-body d-flex flex-column">
            <div class="d-flex justify-content-between mb-2">
              <h6 class="mb-0">Patient Flow (last 14 days)</h6>
              <div class="small-muted">Visits per day</div>
            </div>
            <canvas id="patientFlowChart" style="flex:1;"></canvas>
          </div>
        </div>
      </div>

      <div class="col-lg-4">
        <div class="card chart-card shadow-sm">
          <div class="card-body d-flex flex-column">
            <div class="d-flex justify-content-between mb-2">
              <h6 class="mb-0">Dept. Reports</h6>
              <div class="small-muted">Share by department</div>
            </div>
            <canvas id="deptPieChart" style="max-height:260px;"></canvas>
            <div class="mt-2 d-flex justify-content-center gap-2 small-muted">
              <small><i class="fa fa-square text-primary"></i> OPD</small>
              <small><i class="fa fa-square text-success"></i> Radiology</small>
              <small><i class="fa fa-square text-warning"></i> Lab</small>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- RECENT ACTIVITY + QUICK ACTIONS -->
    <div class="row g-3 mb-4">
      <div class="col-lg-8">
        <div class="card shadow-sm">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h6 class="mb-0">Recent Activity</h6>
              <div class="small-muted">Latest patient access and transfers</div>
            </div>

            <table id="activityTable" class="table table-striped table-hover" style="width:100%">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Time</th>
                  <th>Staff</th>
                  <th>Patient</th>
                  <th>Action</th>
                  <th>Hospital</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                <!-- injected by JS -->
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="col-lg-4">
        <div class="card shadow-sm">
          <div class="card-body">
            <h6>Quick Actions</h6>
            <p class="small-muted">Common tasks for fast access</p>
            <div class="d-grid gap-2">
              <!-- In the Quick Actions section -->
<a href="http://localhost:5001" class="btn btn-primary" target="_blank">
  <i class="fa fa-paper-plane me-2"></i> Send Image
</a>
              <a href="receive.html" class="btn btn-outline-primary"><i class="fa fa-inbox me-2"></i> Receive Image</a>
              <a href="history.html" class="btn btn-outline-secondary"><i class="fa fa-clock-rotate-left me-2"></i> View History</a>
              <button id="toggleDark" class="btn btn-outline-dark"><i class="fa fa-moon me-2"></i> Toggle Dark Mode</button>
            </div>
          </div>
        </div>

        <div class="card mt-3 shadow-sm">
          <div class="card-body">
            <h6 class="mb-2">System Health</h6>
            <div class="small-muted mb-2">Storage & transfer queue</div>
            <div class="progress mb-2" style="height:10px;">
              <div id="storagePct" class="progress-bar" role="progressbar" style="width:0%">0%</div>
            </div>
            <small id="queueInfo" class="small-muted">Queue: 0 jobs</small>
          </div>
        </div>

      </div>
    </div>

    <!-- FOOTER -->
    <footer class="text-center small text-muted mt-4">
      © 2025 Secure Medical Portal · Contact IT Support: it-support@hospital.com
    </footer>
  </div>

  <!-- Toast container -->
  <div class="toast-custom" id="toastContainer"></div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

  <script>
  // ---------- Mock data (replace / fetch from API) ----------
  const MOCK = {
    user: { name: "Dr.Chitra", role: "Doctor", email: "chitra@hospital.com" },
    stats: { patients: 46, active: 12, appointments: 18, upcoming: 6, reports: 7, unreviewed: 4, alerts: 2, critical: 1 },
    flowDays: Array.from({length:14}, (_,i)=> ({day: i+1, count: Math.floor(40 + Math.sin(i/2)*6 + Math.random()*10)})),
    deptShare: { OPD: 55, Radiology: 30, Lab: 15 },
    activity: [
      {id:1, time:"2025-10-09 13:10", staff:"Dr. Chitra", patient:"PAT-1001", action:"Viewed X-ray", hospital:"Local", status:"OK"},
      {id:2, time:"2025-10-09 12:55", staff:"Rad. Kumar", patient:"PAT-0944", action:"Uploaded CT", hospital:"Hospital A", status:"Transferred"},
      {id:3, time:"2025-10-09 11:39", staff:"Nurse A", patient:"PAT-1032", action:"Requested Transfer", hospital:"Hospital B", status:"Pending"},
      {id:4, time:"2025-10-09 09:22", staff:"Dr. R", patient:"PAT-0999", action:"Extracted Image", hospital:"Local", status:"OK"},
    ]
  };

  document.addEventListener('DOMContentLoaded', () => {
    const user = JSON.parse(localStorage.getItem('user')) || MOCK.user;
    document.getElementById('userShortName').innerText = user.name.split(' ')[0];
    document.getElementById('profileName').innerText = user.name;
    document.getElementById('profileNameTop').innerText = user.name;
    document.getElementById('profileEmail').innerText = user.email;
    document.getElementById('profileRoleTop').innerText = user.role;

    document.getElementById('todayDate').innerText = new Date().toLocaleString();

    setStats(MOCK.stats);
    renderPatientFlow(MOCK.flowDays);
    renderDeptPie(MOCK.deptShare);
    populateActivityTable(MOCK.activity);
    addNotification({text: '2 new image transfer requests', time: '5m ago'});

    $('#globalSearch').on('keyup', function() {
      $('#activityTable').DataTable().search($(this).val()).draw();
    });

    document.getElementById('toggleDark').addEventListener('click', toggleDarkMode);
    document.getElementById('logoutBtn').addEventListener('click', () => {
      localStorage.removeItem('user'); localStorage.removeItem('token');
      location.href = 'login.html';
    });

    updateStorage(62, 3);
  });

  function setStats(s) {
    document.getElementById('statPatients').innerText = s.patients;
    document.getElementById('statActive').innerText = s.active;
    document.getElementById('statAppointments').innerText = s.appointments;
    document.getElementById('statUpcoming').innerText = s.upcoming;
    document.getElementById('statReports').innerText = s.reports;
    document.getElementById('statUnreviewed').innerText = s.unreviewed;
    document.getElementById('statAlerts').innerText = s.alerts;
    document.getElementById('statCritical').innerText = s.critical;
  }

  // ---------- Charts ----------
  let flowChart = null;
  function renderPatientFlow(days) {
    const labels = days.map(d => `Day ${d.day}`);
    const data = days.map(d => d.count);
    const ctx = document.getElementById('patientFlowChart').getContext('2d');
    if(flowChart) flowChart.destroy();
    flowChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: 'Patients',
          data,
          tension: 0.35,
          fill: true,
          backgroundColor: 'rgba(13,110,253,0.08)',
          borderColor: 'rgba(13,110,253,0.9)',
          pointRadius: 3
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          x: {
            ticks: {
              autoSkip: false,
              maxRotation: 45,
              minRotation: 45
            }
          },
          y: { beginAtZero: true }
        }
      }
    });
  }

  let deptChart = null;
  function renderDeptPie(share) {
    const ctx = document.getElementById('deptPieChart').getContext('2d');
    if(deptChart) deptChart.destroy();
    deptChart = new Chart(ctx, {
      type:'doughnut',
      data: {
        labels: Object.keys(share),
        datasets: [{
          data: Object.values(share),
          backgroundColor: ['#0d6efd', '#198754', '#ffc107', '#dc3545', '#6f42c1']
        }]
      },
      options: {
        responsive:true,
        plugins:{
          legend:{ position:'bottom' }
        }
      }
    });

    // Generate legend dynamically (avoid duplicates)
    const legendContainer = ctx.canvas.parentElement.querySelector('.mt-2');
    legendContainer.innerHTML = '';
    Object.keys(share).forEach((dept, idx) => {
      const color = deptChart.data.datasets[0].backgroundColor[idx];
      legendContainer.innerHTML += `<small><i class="fa fa-square" style="color:${color}"></i> ${dept}</small>`;
    });
  }

  // ---------- Table ----------
  function populateActivityTable(rows) {
    const tbody = document.querySelector('#activityTable tbody');
    tbody.innerHTML = '';
    rows.forEach(r=>{
      tbody.insertAdjacentHTML('beforeend', `
        <tr>
          <td>${r.id}</td>
          <td>${r.time}</td>
          <td>${r.staff}</td>
          <td>${r.patient}</td>
          <td>${r.action}</td>
          <td>${r.hospital}</td>
          <td>${renderStatus(r.status)}</td>
        </tr>`);
    });

    if($.fn.DataTable.isDataTable('#activityTable')) {
      $('#activityTable').DataTable().destroy();
    }
    $('#activityTable').DataTable({
      pageLength: 6,
      lengthChange:false,
      ordering: true,
      columnDefs: [{ orderable:false, targets:[6] }]
    });
  }

  function renderStatus(s) {
    const cls = s === 'OK' ? 'badge bg-success' : s === 'Pending' ? 'badge bg-warning text-dark' : 'badge bg-info';
    return `<span class="${cls}">${s}</span>`;
  }

  function addNotification(n) {
    const ul = document.getElementById('notifList');
    const noNode = ul.querySelector('.text-center');
    if(noNode) noNode.remove();
    const li = document.createElement('li');
    li.className = 'dropdown-item';
    li.innerHTML = `<div><strong>${n.text}</strong><div class="small-muted">${n.time}</div></div>`;
    ul.insertBefore(li, ul.children[2] || null);
    const count = parseInt(document.getElementById('notifCount').innerText) || 0;
    document.getElementById('notifCount').innerText = count + 1;
  }

  function showToast(message, type='info') {
    const cont = document.getElementById('toastContainer');
    const toastId = 't' + Date.now();
    const color = type === 'success' ? 'bg-success text-white' : type === 'error' ? 'bg-danger text-white' : 'bg-secondary text-white';
    cont.insertAdjacentHTML('beforeend', `
      <div id="${toastId}" class="toast align-items-center ${color} border-0 p-3 mb-2" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
          <div class="toast-body">${message}</div>
          <button type="button" class="btn-close btn-close-white ms-auto me-2" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
      </div>`);
    new bootstrap.Toast(document.getElementById(toastId), { delay: 5000 }).show();
  }

  function updateStorage(percent, queueCount) {
    const bar = document.getElementById('storagePct');
    bar.style.width = percent + '%';
    bar.innerText = percent + '%';
    bar.className = 'progress-bar' + (percent > 80 ? ' bg-danger' : percent > 50 ? ' bg-warning' : ' bg-success');
    document.getElementById('queueInfo').innerText = `Queue: ${queueCount} jobs`;
  }

  function toggleDarkMode() {
    document.body.classList.toggle('bg-dark');
    document.body.classList.toggle('text-light');
    const isDark = document.body.classList.contains('bg-dark');
    localStorage.setItem('darkMode', isDark ? '1' : '0');
    showToast(isDark ? 'Dark mode enabled' : 'Dark mode disabled', 'info');
  }

  if(localStorage.getItem('darkMode') === '1') {
    document.body.classList.add('bg-dark','text-light');
  }
</script>

</body>
</html>
