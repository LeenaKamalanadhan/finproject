<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Fetch Reports - Secure Medical Portal</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <style>
    :root {
      --primary: #0d6efd;
      --muted: #6c757d;
    }
    body { 
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; 
      background:#f6f8fb; 
    }
    /* Sidebar */
    #sidebar {
      min-width: 220px;
      max-width: 220px;
      background: linear-gradient(180deg,#0d6efd,#0056b3);
      color: white;
      height: 100vh;
      position: fixed;
      padding-top: 20px;
    }
    #sidebar .nav-link { color: rgba(255,255,255,0.9); }
    #sidebar .nav-link.active { background: rgba(255,255,255,0.06); border-radius:8px; }

    /* Main */
    #main {
      margin-left: 240px;
      padding: 28px;
    }
    .profile-icon { width:36px; height:36px; border-radius:50%; object-fit:cover; }
    .small-muted { color:var(--muted); font-size:0.9rem; }

    /* Table */
    table th, table td { vertical-align: middle; }

    /* Responsive */
    @media (max-width: 991px) {
      #sidebar { position: relative; width:100%; height:auto; }
      #main { margin-left:0; padding:16px; }
    }
  </style>
</head>
<body>

  <!-- SIDEBAR -->
  <aside id="sidebar" class="d-flex flex-column px-3">
    <div class="text-center mb-3">
      <img src="https://img.icons8.com/ios-filled/80/ffffff/hospital-room.png" width="64" alt="logo">
      <h5 class="mt-2 mb-0">Secure Medical Portal</h5>
    </div>

    <nav class="nav flex-column mb-3">
      <a class="nav-link" href="dashboard.html"><i class="fa fa-home me-2"></i> Dashboard</a>
      <a class="nav-link" href="upload.html"><i class="fa fa-paper-plane me-2"></i> Upload Reports</a>
      <a class="nav-link active" href="fetch.html"><i class="fa fa-inbox me-2"></i> Fetch Reports</a>
      <a class="nav-link" href="history.html"><i class="fa fa-clock-rotate-left me-2"></i> History</a>
      <a class="nav-link" href="users.html"><i class="fa fa-users me-2"></i> Staff</a>
      <a class="nav-link" href="settings.html"><i class="fa fa-gear me-2"></i> Settings</a>
    </nav>

    <div class="mt-auto small text-white-50 px-2 pb-3">
      <div>Version 1.0</div>
      <div class="small-muted">© 2025 Secure Medical</div>
    </div>
  </aside>

  <!-- MAIN -->
  <div id="main">
    <!-- TOP NAV -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h4 class="mb-0">Fetch Reports</h4>
        <small class="small-muted" id="todayDate"></small>
      </div>

      <div class="d-flex align-items-center gap-3">
        <!-- Notifications -->
        <div class="dropdown">
          <button class="btn btn-outline-secondary position-relative" id="notifBtn" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="fa fa-bell"></i>
            <span id="notifCount" class="badge bg-danger position-absolute top-0 start-100 translate-middle rounded-pill">0</span>
          </button>
          <ul class="dropdown-menu dropdown-menu-end" style="min-width:320px;" id="notifList">
            <li class="dropdown-header">Notifications</li>
            <li><hr class="dropdown-divider"></li>
            <li class="text-center small text-muted">No notifications</li>
          </ul>
        </div>

        <!-- Profile -->
        <div class="dropdown">
          <a class="d-flex align-items-center text-decoration-none dropdown-toggle" id="profileMenu" data-bs-toggle="dropdown" href="#">
            <img id="profileThumb" class="profile-icon me-2" src="https://img.icons8.com/ios-filled/100/000000/user.png" alt="profile">
            <div class="text-end d-none d-md-block">
              <div id="profileNameTop">Dr. User</div>
              <small class="small-muted" id="profileRoleTop">Doctor</small>
            </div>
          </a>
          <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="profileMenu">
            <li class="dropdown-item-text"><strong id="profileName">Dr. User</strong><br><small id="profileEmail">email@hospital.com</small></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="profile.html"><i class="fa fa-user me-2"></i> Profile</a></li>
            <li><a class="dropdown-item" href="settings.html"><i class="fa fa-gear me-2"></i> Settings</a></li>
          </ul>
        </div>
      </div>
    </div>

    <!-- FETCH FORM -->
    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <h5 class="mb-3">Fetch Patient Reports</h5>
        <form id="fetchForm" class="row g-3">
          <div class="col-md-6">
            <label for="patientId" class="form-label">Patient ID</label>
            <input type="text" class="form-control" id="patientId" placeholder="Enter Patient ID" required>
          </div>
          <div class="col-md-3 align-self-end">
            <button type="submit" class="btn btn-primary w-100"><i class="fa fa-search me-2"></i>Fetch</button>
          </div>
        </form>
      </div>
    </div>

    <!-- REPORTS TABLE -->
    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="mb-3">Reports</h5>
        <div class="table-responsive">
          <table class="table table-striped align-middle" id="reportsTable">
            <thead class="table-primary">
              <tr>
                <th>#</th>
                <th>Report ID</th>
                <th>Date</th>
                <th>Type</th>
                <th>Summary</th>
                <th>Download</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="6" class="text-center text-muted">No reports fetched yet.</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- FOOTER -->
    <footer class="text-center small text-muted mt-4">
      © 2025 Secure Medical Portal · Contact IT Support: it-support@hospital.com
    </footer>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Set current date
    document.getElementById('todayDate').innerText = new Date().toLocaleString();

    // Load profile info
    const user = JSON.parse(localStorage.getItem('user')) || {name:'Dr. Chithra', role:'Doctor', email:'chitra@hospital.com'};
    document.getElementById('profileName').innerText = user.name;
    document.getElementById('profileNameTop').innerText = user.name;
    document.getElementById('profileEmail').innerText = user.email;
    document.getElementById('profileRoleTop').innerText = user.role;

    // Fetch reports form handler
    document.getElementById('fetchForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const patientId = document.getElementById('patientId').value;
      const tbody = document.querySelector('#reportsTable tbody');
      tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">Loading...</td></tr>`;

      try {
        const response = await fetch(`/api/patients/${patientId}/reports`);
        const data = await response.json();

        tbody.innerHTML = '';
        if (data.reports && data.reports.length > 0) {
          data.reports.forEach((report, index) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${index + 1}</td>
              <td>${report.id}</td>
              <td>${new Date(report.date).toLocaleDateString()}</td>
              <td>${report.type}</td>
              <td>${report.summary || '-'}</td>
              <td>
                <a href="${report.fileUrl}" class="btn btn-sm btn-outline-primary" target="_blank">
                  <i class="fa fa-download"></i> Download
                </a>
              </td>
            `;
            tbody.appendChild(tr);
          });
        } else {
          tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">No reports found for this patient.</td></tr>`;
        }
      } catch (err) {
        console.error(err);
        tbody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">Error fetching reports.</td></tr>`;
      }
    });
  </script>
</body>
</html>
